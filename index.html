<!DOCTYPE html>
<html>
<head>
  <title>MyChat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="utf-8">
  <!-- Bootstrap -->
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
        rel="stylesheet"
        integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
        crossorigin="anonymous">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"
          integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa"
          crossorigin="anonymous"></script>
  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <link rel="stylesheet" type="text/css" href="css/loading.css">
  <style>
    #msg-board {
        top: 0;
        height: 90%;
        width: 100%;
        position: fixed;   
        overflow-y: auto;
    }

    #msg-board .panel {
      /*height: 96%;*/
      padding: 20px;
      box-shadow: none;
    }

    .msg {
      overflow-wrap: normal;
      width: 45%;
    }

    #msg-board .panel .alert {
      max-width: 45%;
    }

    .member-info {
      font-style: italic;
      color: gray;
    }

    .cn-id {
      margin-right: 10px;
    }

  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row" id="msg-board" style="">
        <div class="panel"></div>
    </div>
    <div class="row" style="
    bottom: 0;
    width: 100%;
    position: fixed;">
        <form id="msg-form">
          <div class="col-md-11 col-sm-11 col-xs-9" style="padding: 0">
            <input type="text"
                   class="form-control"
                   name="msg_box"
                   id="msg-box"
                   style="width: 100%; height: 50px">                   
          </div>
          <div class="col-md-1 col-sm-1 col-xs-3" style="padding: 0">
            <button type="button"
              class="btn btn-warning"
             style="width: 100%; height: 50px">Stop</button>            
            
          </div>
        </form>
    </div>
  </div>

  <!-- Modal to enter name -->

<div class="modal fade" id="infoModal"
     data-backdrop="static"
     data-keyboard="false">
  <div class="modal-dialog modal-lg">   
    <div class="modal-content">
      <div class="modal-header">
        <h3>Please enter your Codename and press <code>Enter</code>:</h3>
      </div>
      <div class="modal-body">
        <form id="codename-form">
          <input type="text"
            class="form-control"
            id='codename'>          
        </form>
      </div>
    </div>
  </div>
</div>

  <script>
    
      $(function () {

        var codename = '';
        var typing = false;
        var timeout = undefined;
        var currMsgs = {};

        //select name input
        $('#codename').focus();

        //open modal on load
        $('#infoModal').modal('show');

        $('#codename-form').on('submit',function(e){
          e.preventDefault();

          codename = $('#codename').val();
          if(codename.trim().length < 1)
            return false;


          /*** FORM LISTENERS ***/

          // listener for form
          $('#msg-form').submit(function(e){
            e.preventDefault();

            var msg_txt = $('#msg-box').val();
            if(msg_txt.trim().length < 1)
            return false;

            //send msg to server
            socket.emit('chat message', msg_txt);

            //
            var myMsg = $('<div>').addClass('my-msg')
                        .append(
                          $('<div>').addClass('alert alert-info pull-right')
                                    .append(
                                      $('<div>').addClass('label label-success cn-id')
                                        .text('you')
                                    )
                                    .append(msg_txt)
                        )
                        .append($('<div>').addClass('clearfix'));

            //create a right-pos callout for the message
            $('#msg-board .panel').append(myMsg);

            scrollToMsg(myMsg);
            
            //empty the input
            $('#msg-box').val('');
            //blur and focus to restart typing
            $('#msg-box').blur().focus();

          });

          //typing member inform server
          $('#msg-box').on('keyup keypress',function(){

            if(!typing && $('#msg-box').val().length > 0) {
              typing = true;
              //send info to server
              socket.emit('chat typing',true);  
            }
            else {
              clearTimeout(timeout);
            }

            timeout = setTimeout(
              function() {
                typing = false;
                socket.emit('chat typing',false);              
              },5000
            );

          });

          $('#msg-box').on('focusout',function(){
              socket.emit('chat typing',false);                
              typing = false;
          });


          /*** SOCKETS LISTENERS ***/

          var socket = io();

          //messages listener
          socket.on('chat message', function(msg){
            // just replace the loading placeholder with the new message
            currMsgs[msg.cn].find('.loading').replaceWith(msg.text);

            //remember to delete
            delete currMsgs[msg.cn];

            scrollToMsg(currMsgs[msg.cn]);
          });

          //new joiners listener
          socket.on('chat intro', function(codename){
              $('#msg-board .panel').append(
                $('<div>').addClass('text-center member-info')
                  .html($('<strong>').text(codename))
                  .append(' has joined the chat.')
              );            
          });

          //typing member listener
          socket.on('chat typing',function(member){
            if (!member.typing) {
                //remove the message
                console.log('not typing')
                if(member.cn in currMsgs)
                  currMsgs[member.cn].remove();
            }
            else {
              currMsgs[member.cn] = $('<div>').addClass('his-msg')
                    .append(
                      $('<div>').addClass('alert alert-warning pull-left')
                                .append(
                                  $('<div>').addClass('label label-default cn-id')
                                    .text(member.cn)
                                )
                                .append(
                                  $('<span>').addClass('loading')
                                )
                    )
                    .append($('<div>').addClass('clearfix'));

              $('#msg-board .panel').append(currMsgs[member.cn]);
            }

          });

          //members who leave listener
          socket.on('chat leave', function(codename){
              $('#msg-board .panel').append(
                $('<div>').addClass('text-center member-info')
                  .html($('<strong>').text(codename))
                  .append(' has left the chat.')
              );            
          });


          /*** CUSTOM FUNCTIONS ***/

          //scrolldown function
          function scrollToMsg(target) {  
            $('#msg-board').animate({
              scrollTop: $('#msg-board').prop("scrollHeight")
            }, 2000);
          }


          /*** EXECUTION STARTS HERE ***/

          socket.emit('chat intro', codename);

          $('#infoModal').modal('hide');

          //greeting to the user
          $('#msg-board .panel').append(
            $('<div>').addClass('text-center member-info')
                .text('Welcome to the group, ')
                .append($('<strong>').text(codename))
                .append('!')
          );

          $('#msg-box').focus();

        });
      });
  </script>
</body>

</html>